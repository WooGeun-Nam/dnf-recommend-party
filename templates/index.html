<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ëª¨í—˜ë‹¨ íŒŒí‹° í¸ì„±</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4"
  >
    <!-- âœ… ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="w-full max-w-4xl flex justify-center gap-10 py-4">
      <a
        href="#"
        class="text-lg font-semibold text-white relative pb-2 after:absolute after:left-0 after:bottom-0 after:w-full after:h-0.5 after:bg-purple-500"
        >ìºë¦­í„° ê²€ìƒ‰</a
      >
      <a
        href="/multinput"
        class="text-lg font-semibold text-gray-400 hover:text-white relative pb-2 transition duration-300 ease-in-out after:absolute after:left-1/2 after:bottom-0 after:w-0 after:h-0.5 after:bg-purple-500 after:transition-all after:duration-300 hover:after:w-full hover:after:left-0"
        >ëª¨í—˜ë‹¨ ë“±ë¡</a
      >
      <a
        href="/party"
        class="text-lg font-semibold text-gray-400 hover:text-white relative pb-2 transition duration-300 ease-in-out after:absolute after:left-1/2 after:bottom-0 after:w-0 after:h-0.5 after:bg-purple-500 after:transition-all after:duration-300 hover:after:w-full hover:after:left-0"
        >íŒŒí‹° í¸ì„±</a
      >
    </nav>

    <h2 class="text-3xl font-bold mt-6">ìºë¦­í„° ê²€ìƒ‰</h2>

    <div class="flex flex-wrap items-center gap-3 mt-4">
      <!-- âœ… Tailwind ìŠ¤íƒ€ì¼ ì ìš©ëœ ë“œë¡­ë‹¤ìš´ -->
      <select id="search_type" class="p-2 bg-gray-800 text-white rounded-lg">
        <option value="all" selected>ì „ì²´</option>
        <option value="adventure">ëª¨í—˜ë‹¨</option>
        {% for server in servers %}
        <option value="{{ server.serverId }}">{{ server.serverName }}</option>
        {% endfor %}
      </select>

      <!-- âœ… Tailwind ìŠ¤íƒ€ì¼ ì ìš©ëœ ê²€ìƒ‰ì°½ -->
      <input
        type="text"
        id="search_input"
        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        class="p-2 w-64 bg-gray-800 text-white rounded-lg border border-gray-600"
        onkeypress="if(event.key==='Enter') search()"
      />

      <!-- âœ… Tailwind ë²„íŠ¼ ìŠ¤íƒ€ì¼ -->
      <div class="flex items-center gap-3">
        <!-- âœ… ê²€ìƒ‰ ë²„íŠ¼ -->
        <button
          onclick="search()"
          class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white font-semibold"
        >
          ê²€ìƒ‰
        </button>

        <!-- âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <button
          id="refreshButton"
          onclick="refreshAdventure()"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg text-white font-semibold hidden"
        >
          ìƒˆë¡œê³ ì¹¨
        </button>

        <!-- âœ… íŒŒí‹° ì¶”ì²œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <button
          id="partyRecommendBtn"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-400 rounded-lg text-white font-semibold hidden"
          onclick="autoPartyFromSearch()"
        >
          ë²êµì¶”ì²œ
        </button>
      </div>
    </div>

    <!-- ê¸°ì¡´ ìºë¦­í„° ê²€ìƒ‰ ê²°ê³¼ -->
    <div
      id="result"
      class="mt-6 w-full max-w-[1300px] flex flex-wrap justify-center gap-8 mx-auto overflow-x-hidden"
    ></div>

    <!-- ğŸ”¹ íŒŒí‹° ì¶”ì²œ ê²°ê³¼ ì „ìš© ì»¨í…Œì´ë„ˆ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
    <div
      id="party-result"
      class="mt-6 w-full max-w-6xl mx-auto grid grid-cols-2 gap-8 justify-center hidden"
    ></div>

    <script>
      function search() {
        let type = document.getElementById("search_type").value;
        let searchValue = document.getElementById("search_input").value;

        if (!type || !searchValue) {
          alert("ê²€ìƒ‰ ìœ í˜•ê³¼ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        // íŒŒí‹° ì¶”ì²œ ê²°ê³¼ ì˜ì—­ì€ ìˆ¨ê¹€ ì²˜ë¦¬
        let partyResult = document.getElementById("party-result");
        if (partyResult) {
          partyResult.innerHTML = "";
          partyResult.classList.add("hidden");
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ì„ ë³´ì´ê²Œ ì„¤ì •
        let resultArea = document.getElementById("result");
        resultArea.classList.remove("hidden");
        resultArea.innerHTML =
          "<p class='text-lg text-gray-400'>ê²€ìƒ‰ ì¤‘...</p>";

        let apiUrl =
          type === "adventure"
            ? `/search_adventure?adventure_name=${searchValue}`
            : `/search_character?character_name=${searchValue}&server_id=${type}`;

        fetch(apiUrl)
          .then((response) => response.json())
          .then((data) => {
            resultArea.innerHTML = "";
            if (data.error) {
              resultArea.innerHTML = `<p class="text-red-400">${data.error}</p>`;
              document.getElementById("refreshButton").classList.add("hidden");
              document
                .getElementById("partyRecommendBtn")
                .classList.add("hidden");
            } else {
              renderCharacters(data);
              if (type === "adventure") {
                document
                  .getElementById("refreshButton")
                  .classList.remove("hidden");
                document
                  .getElementById("partyRecommendBtn")
                  .classList.remove("hidden");
              } else {
                document
                  .getElementById("refreshButton")
                  .classList.add("hidden");
                document
                  .getElementById("partyRecommendBtn")
                  .classList.add("hidden");
              }
            }
          });
      }

      function renderCharacters(data) {
        let resultArea = document.getElementById("result");
        resultArea.innerHTML = "";

        if (data.error) {
          resultArea.innerHTML = `<p class="text-red-400">${data.error}</p>`;
        } else {
          data.forEach((char) => {
            let fameDisplay =
              char.fame && char.fame > 0
                ? `<p class="text-blue-400">ëª…ì„±: <span class="font-semibold">${char.fame.toLocaleString()}</span></p>`
                : "";

            resultArea.innerHTML += `
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg text-center w-64 h-80 flex flex-col items-center justify-start">
          <img src="${char.characterImg}" 
               alt="ìºë¦­í„° ì´ë¯¸ì§€" 
               class="w-40 h-40 mx-auto rounded-md object-cover">
          
          <!-- ëª¨í—˜ë‹¨ëª… -->
          <p class="text-sm text-gray-400 mt-2">
            ${char.adventureName ? char.adventureName : "ëª¨í—˜ë‹¨ ì—†ìŒ"}
          </p>
          <!-- ìºë¦­í„° ì´ë¦„ -->
          <p class="text-yellow-400 text-xl font-bold">
            ${char.characterName}
          </p>
          <!-- ì§ì—…ëª… ë° ì„œë²„ëª… -->
          <p class="text-gray-300">
            ${char.jobName} | ${char.serverName}
          </p>
          ${fameDisplay}
        </div>
      `;
          });
        }
      }

      function refreshAdventure() {
        let adventureName = document.getElementById("search_input").value;
        if (!adventureName) {
          alert("ëª¨í—˜ë‹¨ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // íŒŒí‹° ì¶”ì²œ ê²°ê³¼ ì˜ì—­ì€ ìˆ¨ê¹€ ì²˜ë¦¬
        let partyResult = document.getElementById("party-result");
        if (partyResult) {
          partyResult.innerHTML = "";
          partyResult.classList.add("hidden");
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ì„ ë³´ì´ê²Œ ì„¤ì •
        let resultArea = document.getElementById("result");
        resultArea.classList.remove("hidden");
        resultArea.innerHTML =
          "<p class='text-lg text-gray-400'>ìƒˆë¡œê³ ì¹¨ ì¤‘...</p>";

        fetch(`/refresh_adventure?adventure_name=${adventureName}`)
          .then((response) => response.json())
          .then((data) => {
            resultArea.innerHTML = "";
            if (data.error) {
              resultArea.innerHTML = `<p class="text-red-400">${data.error}</p>`;
            } else {
              renderCharacters(data); // âœ… ìµœì‹  ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸
            }
          });
      }

      function searchAdventurer() {
        let adventureName = document.getElementById("adventureName").value;
        if (!adventureName) {
          alert("ëª¨í—˜ë‹¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
          return;
        }

        fetch(`/search_adventurer?name=${adventureName}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
              return;
            }

            // âœ… ê²€ìƒ‰ëœ ìºë¦­í„° ëª©ë¡ ë Œë”ë§
            renderAdventurerList(data.characters);
          });
      }

      function autoPartyFromSearch() {
        let adventureInput = document.getElementById("search_input");
        if (!adventureInput) {
          alert("ëª¨í—˜ë‹¨ ê²€ìƒ‰ì°½ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        let adventureName = adventureInput.value.trim();
        if (!adventureName) {
          alert("ëª¨í—˜ë‹¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
          return;
        }

        let partyResult = document.getElementById("party-result");
        let characterResult = document.getElementById("result");

        // âœ… ê¸°ì¡´ ê²€ìƒ‰ëœ ìºë¦­í„° ê²°ê³¼ ìˆ¨ê¸°ê¸°
        characterResult.classList.add("hidden");

        // âœ… ìƒˆë¡œìš´ íŒŒí‹° ì¶”ì²œ ê²°ê³¼ë¥¼ ë¡œë”© ìƒíƒœë¡œ ì„¤ì •
        partyResult.innerHTML =
          "<p class='text-lg text-gray-400'>íŒŒí‹° ì¶”ì²œ ì¤‘...</p>";
        partyResult.classList.remove("hidden");

        fetch(`/auto_party?adventures=${adventureName}`)
          .then((response) => response.json())
          .then((data) => {
            partyResult.innerHTML = "";
            if (data.error) {
              partyResult.innerHTML = `<p class='text-red-400'>${data.error}</p>`;
              return;
            }

            // âœ… íŒŒí‹° ê²°ê³¼ ë Œë”ë§
            renderParty(data);
          })
          .catch((error) => {
            console.error("ğŸ”´ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function renderParty(data) {
        let resultArea = document.getElementById("party-result");
        resultArea.innerHTML = "";

        data.forEach((party) => {
          // íŒŒí‹° ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
          let partyDiv = document.createElement("div");
          partyDiv.className =
            "bg-gray-800 p-4 rounded-lg shadow-lg w-full max-w-md mx-auto mb-6";

          // íŒŒí‹° ë²ˆí˜¸ ì œëª©
          /*
          let title = document.createElement("h2");
          title.className =
            "text-lg font-bold text-yellow-400 mb-4 text-center";
          title.innerText = `íŒŒí‹° ${party.partyNumber}`;
          partyDiv.appendChild(title);*/

          // íŒŒí‹° ë©¤ë²„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ
          let membersDiv = document.createElement("div");
          membersDiv.className = "grid grid-cols-2 gap-4";

          party.members.forEach((member) => {
            let card = document.createElement("div");
            card.className = "bg-gray-700 p-3 rounded-lg text-center shadow-md";

            let role = document.createElement("p");
            role.className = "text-sm font-semibold text-gray-300";
            role.innerText = member.role;

            let img = document.createElement("img");
            img.src = member.image;
            img.alt = member.name;
            img.className = "w-20 h-20 mx-auto my-2 rounded-md object-cover";

            let name = document.createElement("p");
            name.className = "text-md font-bold";
            name.innerText = member.name;

            let job = document.createElement("p");
            job.className = "text-sm text-gray-400";
            job.innerText = member.job;

            let fame = document.createElement("p");
            fame.className = "text-sm text-blue-400";
            fame.innerText = `ëª…ì„±: ${member.fame.toLocaleString()}`;

            card.appendChild(role);
            card.appendChild(img);
            card.appendChild(name);
            card.appendChild(job);
            card.appendChild(fame);

            membersDiv.appendChild(card);
          });

          partyDiv.appendChild(membersDiv);

          // ìƒê¸‰ë˜ì „ ì…ì¥ ê°€ëŠ¥ ì •ë³´ í‘œì‹œ
          let dungeonInfo = document.createElement("div");
          dungeonInfo.className = "mt-4 text-center";
          // âœ… ìƒê¸‰ ë˜ì „ ì¶œë ¥
          if (party.eligibleHighLevelDungeons.length > 0) {
            dungeonInfo.innerHTML += `<p class="text-green-400 font-semibold">ì…ì¥ ì¶”ì²œ ìƒê¸‰ ë˜ì „:</p>
                            <p class="text-sm text-gray-300">${party.eligibleHighLevelDungeons.join(
                              ", "
                            )}</p>`;
          }
          // âœ… ë ˆê¸°ì˜¨ ë˜ì „ ì¶œë ¥
          if (party.eligibleLegionDungeons.length > 0) {
            dungeonInfo.innerHTML += `<p class="text-green-400 font-semibold mt-2">ì…ì¥ ì¶”ì²œ ë ˆê¸°ì˜¨ ë˜ì „:</p>
                            <p class="text-sm text-gray-300">${party.eligibleLegionDungeons.join(
                              ", "
                            )}</p>`;
          }
          // âœ… ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ ì¶œë ¥
          if (
            !party.eligibleHighLevelDungeons.length &&
            !party.eligibleLegionDungeons.length
          ) {
            dungeonInfo.innerHTML = `<p class="text-red-400 font-semibold">ì…ì¥ ê°€ëŠ¥í•œ ë˜ì „ ì—†ìŒ</p>`;
          }
          partyDiv.appendChild(dungeonInfo);

          resultArea.appendChild(partyDiv);
        });
      }
    </script>
  </body>
</html>
